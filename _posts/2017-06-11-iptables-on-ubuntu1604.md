---
layout: post
title: Ubuntu16.04@さくらのVPS にて iptables の設定
date: '2017-06-11T15:11:03+0900'
main-class: vps
tags:
  - iptables
  - ubuntu
---

iptables の初期値はすべてスルーするようになっている

```bash
% sudo iptables -L
Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination
```

```bash
# iptables-persistent をインストール
# このとき現在の設定から rules.v4, rules.v6 が作成される
% sudo apt-get install iptables-persistent

# 設定スクリプトを作成
% sudo vi /etc/iptables/iptables.sh

# 設定スクリプトを実行
% sudo sh /etc/iptables/iptables.sh

# 正しく設定されているかを確認
% sudo iptables -L
Chain INPUT (policy DROP)
target     prot opt source               destination
ACCEPT     all  --  anywhere             anywhere
DROP       all  --  10.0.0.0/8           anywhere
DROP       all  --  172.16.0.0/12        anywhere
DROP       all  --  192.168.0.0/16       anywhere
ACCEPT     icmp --  anywhere             anywhere             icmp echo-request
ACCEPT     all  --  anywhere             anywhere             state RELATED,ESTABLISHED
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:http
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:https
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:12345
LOG        all  --  anywhere             anywhere             limit: avg 1/sec burst 5 LOG level warning prefix "[IPTABLES INPUT] : "
DROP       all  --  anywhere             anywhere

Chain FORWARD (policy DROP)
target     prot opt source               destination
LOG        all  --  anywhere             anywhere             limit: avg 1/sec burst 5 LOG level warning prefix "[IPTABLES FORWARD] : "
DROP       all  --  anywhere             anywhere

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination
ACCEPT     all  --  anywhere             anywhere

# rules.v4 が更新されているかを確認
% sudo cat /etc/iptables/rules.v4
# Generated by iptables-save v1.4.21 on Sun Jun 11 15:24:04 2017
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -i lo -j ACCEPT
-A INPUT -s 10.0.0.0/8 -j DROP
-A INPUT -s 172.16.0.0/12 -j DROP
-A INPUT -s 192.168.0.0/16 -j DROP
-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 12345 -j ACCEPT
-A INPUT -m limit --limit 1/sec -j LOG --log-prefix "[IPTABLES INPUT] : "
-A INPUT -j DROP
-A FORWARD -m limit --limit 1/sec -j LOG --log-prefix "[IPTABLES FORWARD] : "
-A FORWARD -j DROP
-A OUTPUT -o lo -j ACCEPT
COMMIT
# Completed on Sun Jun 11 15:24:04 2017

# 現在の設定を永続化する
% sudo service iptables-persistent start
```

ちなみに iptables.sh の中身

```bash
#!/bin/sh

# Initialize table
/sbin/iptables -F
# Delete declaration chain
/sbin/iptables -X

# Set default rules
/sbin/iptables -P INPUT DROP
/sbin/iptables -P OUTPUT ACCEPT
/sbin/iptables -P FORWARD DROP

# Allow access from localhost
/sbin/iptables -A INPUT -i lo -j ACCEPT
/sbin/iptables -A OUTPUT -o lo -j ACCEPT

# Destroy access from private ip addresses
/sbin/iptables -A INPUT -s 10.0.0.0/8 -j DROP
/sbin/iptables -A INPUT -s 172.16.0.0/12 -j DROP
/sbin/iptables -A INPUT -s 192.168.0.0/16 -j DROP

# Allow ping
/sbin/iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT

# Allow reply to external that is done from internal
/sbin/iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Destroy access from dropped ip addresses
if [ -s /etc/iptables/drop_ip ]; then
  for ip in `cat /etc/iptables/drop_ip`
  do
    /sbin/iptables -I INPUT -s $ip -j DROP
  done
fi

# Allow accesses from defined services.
# HTTP
/sbin/iptables -A INPUT -p tcp --dport 80 -j ACCEPT
# HTTPS
/sbin/iptables -A INPUT -p tcp --dport 443 -j ACCEPT
# ssh
/sbin/iptables -A INPUT -p tcp --dport 12345 -j ACCEPT

# Destroy unmatched accesses with logging
/sbin/iptables -A INPUT -m limit --limit 1/s -j LOG --log-prefix '[IPTABLES INPUT] : '
/sbin/iptables -A INPUT -j DROP
/sbin/iptables -A FORWARD -m limit --limit 1/s -j LOG --log-prefix '[IPTABLES FORWARD] : '
/sbin/iptables -A FORWARD -j DROP

# Save rule
/sbin/iptables-save > /etc/iptables/rules.v4
```

これで IPv4 の設定が完了したが、IPv6 は全スルーのままなので、IPv6 を無効化する。

```bash
% sudo echo 'net.ipv6.conf.all.disable_ipv6 = 1' >> /etc/sysctl.conf
% sudo echo 'net.ipv6.conf.default.disable_ipv6 = 1' >> /etc/sysctl.conf
% sudo sysctl -p
```
